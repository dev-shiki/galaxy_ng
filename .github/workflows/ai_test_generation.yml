name: AI-Powered Test Generation

on:
  workflow_dispatch:
    inputs:
      limit:
        description: 'Maximum number of modules to generate tests for'
        required: false
        default: '5'
        type: number
      model:
        description: 'SambaNova model to use'
        required: false
        default: 'Qwen2.5-Coder-32B-Instruct'
        type: string
      create_pr:
        description: 'Create PR with generated tests'
        required: false
        default: true
        type: boolean

jobs:
  # Run the existing test workflow using the workflow_call feature
  run-tests:
    uses: ./.github/workflows/ci_full.yml

  generate-tests:
    name: Generate Tests with AI
    runs-on: ubuntu-latest
    needs: run-tests
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      
      - name: Install system dependencies
        run: |
          sudo apt update
          sudo apt install -y libsasl2-dev libldap2-dev libssl-dev gettext
      
      - name: Download coverage from test job
        uses: actions/download-artifact@v4
        with:
          name: coverage
          path: ./
      
      - name: Install required packages
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install pytest pytest-cov coverage[toml]
      
      - name: Analyze coverage for test candidates
        run: |
          python .github/scripts/coverage_analyzer.py coverage.xml test_candidates.json
      
      - name: Generate tests with AI
        env:
          SAMBANOVA_API_KEY: ${{ secrets.SAMBANOVA_API_KEY }}
        run: |
          python .github/scripts/ai_test_generator.py \
            --candidates test_candidates.json \
            --limit ${{ github.event.inputs.limit }} \
            --model ${{ github.event.inputs.model }} \
            --output-dir generated_tests
      
      - name: Install project for test validation
        run: |
          pip install -e .
          for req_file in dev_requirements.txt unittest_requirements.txt; do
            if [ -f "$req_file" ]; then
              pip install -r "$req_file" || echo "Warning: Some packages in $req_file failed to install"
            fi
          done
      
      - name: Validate generated tests
        run: |
          python .github/scripts/test_validator.py generated_tests/generation_results.json coverage.xml
      
      - name: Upload generated tests as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: generated-tests
          path: |
            generated_tests/
            test_candidates.json
          retention-days: 7
      
      - name: Create PR with Generated Tests
        if: ${{ github.event.inputs.create_pr == 'true' && hashFiles('generated_tests/validation_results.json') != '' }}
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "AI-Generated tests to improve coverage"
          title: "AI-Generated Tests to improve coverage"
          body: |
            This PR contains AI-generated tests to improve code coverage.
            
            Tests were generated by analyzing modules with low coverage and using SambaNova's AI to create appropriate test cases.
            
            Generated using:
            - Model: ${{ github.event.inputs.model }}
            - Modules analyzed: ${{ github.event.inputs.limit }}
            
            No-Issue
          branch: ai-generated-tests-${{ github.run_id }}
          base: ${{ github.ref_name }}
          labels: |
            ai-generated
            testing
            automated-pr